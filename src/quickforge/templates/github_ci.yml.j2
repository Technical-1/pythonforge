# =============================================================================
# {{ config.name }} - GitHub Actions CI Workflow
# =============================================================================
# Generated by quickforge v{{ quickforge_version }}
#
# This workflow runs on every push and pull request to ensure code quality.
# It performs the following checks:
# - Linting with ruff
# - Formatting with ruff
# - Type checking with {{ config.tooling.type_checker }}
# - Testing with pytest across multiple Python versions
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  # Allow manual triggering
  workflow_dispatch:

# Cancel in-progress runs on new commits to same branch
concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.ref }}{% endraw %}

  cancel-in-progress: true

env:
  # Force color output in CI
  FORCE_COLOR: "1"
  # uv settings
  UV_SYSTEM_PYTHON: "1"

jobs:
  # ===========================================================================
  # Quality Checks (fast, single Python version)
  # ===========================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
      
      - name: Install Python {{ config.python_version.value }}
        run: uv python install {{ config.python_version.value }}
      
      - name: Install dependencies
        run: uv sync --dev
      
      - name: Run ruff linter
        run: uv run ruff check . --output-format=github
      
      - name: Run ruff formatter
        run: uv run ruff format --check .
      
      - name: Run type checker
        run: uv run {{ config.tooling.type_checker }}

  # ===========================================================================
  # Tests (multiple Python versions)
  # ===========================================================================
  test:
    name: Test (Python {% raw %}${{ matrix.python-version }}{% endraw %})
    runs-on: ubuntu-latest
    needs: quality  # Only run tests if quality checks pass
    
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "{{ config.python_version.value }}"
{% if config.python_version.value == "3.11" %}
          - "3.12"
          - "3.13"
{% elif config.python_version.value == "3.12" %}
          - "3.13"
{% endif %}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
      
      - name: Install Python {% raw %}${{ matrix.python-version }}{% endraw %}

        run: uv python install {% raw %}${{ matrix.python-version }}{% endraw %}

      
      - name: Install dependencies
        run: uv sync --dev
      
      - name: Run tests
        run: uv run pytest --cov-report=xml
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == '{{ config.python_version.value }}'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}


  # ===========================================================================
  # All Checks Passed
  # ===========================================================================
  # This job is used as a required status check in branch protection rules.
  # It only succeeds if all other jobs pass.
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: always()
    
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "{% raw %}${{ needs.quality.result }}{% endraw %}" != "success" ]] || \
             [[ "{% raw %}${{ needs.test.result }}{% endraw %}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All checks passed! âœ…"
